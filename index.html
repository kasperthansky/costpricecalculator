<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cost Price Calculator — v1.5</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root { --bg:#f7f8fc; --fg:#0f172a; --muted:#475569; --card:#ffffff; --border:#e2e8f0; --accent:#0ea5e9; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;line-height:1.35}
    .wrap{max-width:900px;margin:28px auto;padding:0 16px}
    .h1{font-size:28px;font-weight:700;margin:0}
    .version{color:var(--muted);font-size:12px;margin-top:4px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.03); overflow:hidden}
    .step{margin-top:14px}
    .step h2{font-size:18px;margin:0 0 10px}
    .grid2{display:grid;gap:12px}
    @media(min-width:720px){.grid2{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px}
    input[type=text]{width:100%;max-width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:#fff;outline:none}
    input[type=text]:focus{border-color:#cbd5e1; box-shadow:0 0 0 3px rgba(148,163,184,.2)}
    fieldset{border:1px solid var(--border);border-radius:12px;padding:10px;min-width:0}
    legend{color:var(--muted);font-size:12px;padding:0 6px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .radio{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    .errors{background:#fee2e2;border:1px solid #fecaca;color:#991b1b;border-radius:10px;padding:10px;font-size:14px;margin-top:10px}
    .results{display:grid;gap:12px;margin-top:12px}
    @media(min-width:720px){.results{grid-template-columns:repeat(4,1fr)}}
    .res{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .res .t{font-size:12px;color:var(--muted)}
    .res .v{font-size:18px;font-weight:600;margin-top:4px}
    .total{display:flex;align-items:center;justify-content:space-between;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:12px;gap:12px;flex-wrap:wrap}
    .link{color:#0369a1;cursor:pointer;text-decoration:underline}
    .bar{margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
    .btn:hover{background:#f8fafc}
    details{border:1px solid var(--border);border-radius:10px;padding:10px}
    details>summary{cursor:pointer;color:#0f172a;font-weight:600}
    .center{display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="h1">Cost Price Calculator</h1>
    <div class="version">v1.5</div>

    <!-- Step 1: Valuta & told -->
    <section class="card step">
      <h2>1. Valuta & told</h2>
      <div class="grid2">
        <div>
          <label for="eur">EUR → DKK <span class="hint" id="eurMeta"></span></label>
          <input id="eur" type="text" inputmode="decimal" value="7,45" placeholder="fx 7,45">
          <div class="hint">Kurs hentes automatisk. Du kan altid rette den.</div>
        </div>
        <div>
          <label for="jpy">JPY → DKK <span class="hint" id="jpyMeta"></span></label>
          <input id="jpy" type="text" inputmode="decimal" value="0,046" placeholder="fx 0,046">
          <div class="hint">Bruges hvis prisen står i JPY.</div>
        </div>
        <div>
          <label for="dutyPct">Toldsats (%)</label>
          <input id="dutyPct" type="text" inputmode="decimal" value="8,5" placeholder="fx 8,5">
          <div class="hint">Fx 8,5 for 8,5%.</div>
        </div>
      </div>
      <div class="bar">
        <button class="btn" id="refreshFx">Opdatér valutakurser</button>
        <span class="hint" id="fxInfo">Kursdata: standardværdier (kan redigeres).</span>
        <details style="margin-left:auto">
          <summary>Avanceret</summary>
          <div class="hint" style="margin-top:8px">
            <label><input id="rounding" type="checkbox" checked> Vis afrundede beløb</label>
          </div>
        </details>
      </div>
    </section>

    <!-- Step 2: Kostpris -->
    <section class="card step">
      <h2>2. Kostpris</h2>
      <div class="row">
        <div class="radio">
          <span class="hint">Valuta for kostpris:</span>
          <label><input type="radio" name="priceCcy" value="JPY" checked> JPY</label>
          <label><input type="radio" name="priceCcy" value="EUR"> EUR</label>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div>
          <label for="unitPrice">Kostpris pr. stk (<span id="priceCcyLabel">JPY</span>)</label>
          <input id="unitPrice" type="text" inputmode="decimal" placeholder="Indtast prisen pr. stk her">
        </div>
        <div>
          <label for="discount">Rabat (DKK) pr. stk <span class="hint">(valgfrit)</span></label>
          <input id="discount" type="text" inputmode="decimal" placeholder="Indtast rabat i kroner (kan være 0)">
        </div>
      </div>
    </section>

    <!-- Step 3: Fragt -->
    <section class="card step">
      <h2>3. Fragt</h2>
      <div class="row">
        <div class="radio">
          <span class="hint">Valuta for fragt:</span>
          <label><input type="radio" name="freightCcy" value="JPY" checked> JPY</label>
          <label><input type="radio" name="freightCcy" value="EUR"> EUR</label>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div>
          <label for="freightTotal">Fragt i alt (<span id="freightCcyLabel">JPY</span>)</label>
          <input id="freightTotal" type="text" inputmode="decimal" placeholder="Indtast samlet fragt for hele ordren">
        </div>
        <div>
          <label for="qty">Antal varer</label>
          <input id="qty" type="text" inputmode="numeric" placeholder="Hvor mange varer fordeles fragten på?">
        </div>
      </div>
      <div id="helper" class="hint" style="margin-top:8px">Udfyld felterne herover for at se resultatet.</div>
      <div id="errors" class="errors" style="display:none"></div>
    </section>

    <!-- Results -->
    <section class="total">
      <div>
        <div class="hint">Total kostpris pr. stk</div>
        <div style="font-size:28px;font-weight:700" id="total">-</div>
      </div>
      <div class="hint" id="notes"></div>
    </section>

    <section class="results">
      <div class="res"><div class="t">Kostpris (DKK)</div><div class="v" id="costDKK">-</div></div>
      <div class="res"><div class="t">Kostpris m/ rabat</div><div class="v" id="netCost">-</div></div>
      <div class="res"><div class="t">Andel fragt pr. stk</div><div class="v" id="freightPerUnit">-</div></div>
      <div class="res"><div class="t">Told</div><div class="v" id="dutyAmt">-</div></div>
    </section>

    <div class="center" style="margin:16px 0 40px">
      <span class="link" id="reset">Nulstil alle felter</span>
    </div>
  </div>

  <script>
    (function(){
      const qs = (x) => document.querySelector(x);
      const qsa = (x) => Array.from(document.querySelectorAll(x));

      // convert "7,5" → 7.5, handle thousand separators like 37.960 or 37 960
      const toNumber = (str) => {
        if (typeof str !== 'string') str = String(str ?? '');
        str = str.trim().replace(/\\s/g, '');
        // remove thousand dots e.g. 37.960 or 31.308
        if (/^\\d{1,3}(\\.\\d{3})+(,\\d+)?$/.test(str)) { str = str.replace(/\\./g, ''); }
        str = str.replace(',', '.');
        const n = Number(str);
        return isFinite(n) ? n : NaN;
      };

      const fmtDKK = (n, rounding) => {
        if (n == null || isNaN(n)) return "-";
        const v = rounding ? Math.round(n * 100) / 100 : n;
        return v.toLocaleString('da-DK', { style: 'currency', currency: 'DKK' });
      };

      function val(id){ return toNumber(qs(id).value); }

      // Local storage helpers
      const LS_KEY = 'cost_price_calc_v1_5';
      function save(){
        const payload = {
          eur: qs('#eur').value,
          jpy: qs('#jpy').value,
          dutyPct: qs('#dutyPct').value,
          rounding: qs('#rounding').checked,
          priceCcy: qsa('input[name=priceCcy]').find(x=>x.checked).value,
          unitPrice: qs('#unitPrice').value,
          discount: qs('#discount').value,
          freightCcy: qsa('input[name=freightCcy]').find(x=>x.checked).value,
          freightTotal: qs('#freightTotal').value,
          qty: qs('#qty').value,
          fxMeta: qs('#fxInfo').dataset.meta || ''
        };
        localStorage.setItem(LS_KEY, JSON.stringify(payload));
      }
      function load(){
        const saved = localStorage.getItem(LS_KEY);
        if(!saved) return;
        try{
          const o = JSON.parse(saved);
          if(o.eur) qs('#eur').value = o.eur;
          if(o.jpy) qs('#jpy').value = o.jpy;
          if(o.dutyPct) qs('#dutyPct').value = o.dutyPct;
          if(typeof o.rounding === 'boolean') qs('#rounding').checked = o.rounding;
          if(o.priceCcy) qsa('input[name=priceCcy]').forEach(x=> x.checked = (x.value===o.priceCcy));
          if(o.unitPrice) qs('#unitPrice').value = o.unitPrice;
          if(o.discount) qs('#discount').value = o.discount;
          if(o.freightCcy) qsa('input[name=freightCcy]').forEach(x=> x.checked = (x.value===o.freightCcy));
          if(o.freightTotal) qs('#freightTotal').value = o.freightTotal;
          if(o.qty) qs('#qty').value = o.qty;
          if(o.fxMeta){ const m = o.fxMeta.split('|'); if(m[0]) qs('#fxInfo').textContent = m[0]; if(m[1]) qs('#fxInfo').dataset.meta = o.fxMeta; }
        }catch(e){}
      }

      let hasInteracted = false;
      ['#unitPrice','#freightTotal','#qty','#eur','#jpy','#dutyPct','#discount'].forEach(id=> {
        qs(id).addEventListener('input', () => { hasInteracted = true; qs('#helper').style.display='none'; });
      });
      qsa('input[type=radio]').forEach(el=> el.addEventListener('change', () => { hasInteracted = true; qs('#helper').style.display='none'; }));

      function recalc(){
        const errors = [];
        const eur = val('#eur');
        const jpy = val('#jpy');
        const dutyPct = val('#dutyPct');
        const rounding = qs('#rounding').checked;

        const priceCcy = qsa('input[name=priceCcy]').find(x=>x.checked).value;
        const freightCcy = qsa('input[name=freightCcy]').find(x=>x.checked).value;

        qs('#priceCcyLabel').textContent = priceCcy;
        qs('#freightCcyLabel').textContent = freightCcy;

        const unitPrice = val('#unitPrice');
        const discount = val('#discount');
        const freightTotal = val('#freightTotal');
        const qty = val('#qty');

        // Validate only after some interaction
        if (hasInteracted) {
          if(!(eur>0)) errors.push('EUR→DKK skal være > 0.');
          if(!(jpy>0)) errors.push('JPY→DKK skal være > 0.');
          if(!(unitPrice>0)) errors.push('Angiv kostpris > 0.');
          if(!(discount>=0)) errors.push('Rabat (DKK) kan ikke være negativ.');
          if(!(freightTotal>=0)) errors.push('Fragt kan ikke være negativ.');
          if(!(qty>0)) errors.push('Antal skal være > 0.');
          if(!(dutyPct>=0)) errors.push('Toldsats kan ikke være negativ.');
        }

        const errBox = qs('#errors');
        if(errors.length){
          errBox.style.display='block';
          errBox.innerHTML = '<ul style="margin:0;padding-left:18px">' + errors.map(e=>'<li>'+e+'</li>').join('') + '</ul>';
        } else {
          errBox.style.display='none';
          errBox.innerHTML = '';
        }

        if(!(unitPrice>0) || !(qty>0) || !(eur>0) || !(jpy>0) || !(dutyPct>=0)) {
          ['#costDKK','#netCost','#freightPerUnit','#dutyAmt','#total'].forEach(id=> qs(id).textContent='-');
          qs('#notes').textContent = '';
          return;
        }

        const dutyRate = dutyPct / 100; // convert percent to decimal

        const costDKK = priceCcy==='JPY' ? unitPrice * jpy : unitPrice * eur;
        const netCost = costDKK - (isNaN(discount)?0:discount);
        const freightDKKTotal = freightCcy==='JPY' ? freightTotal * jpy : freightTotal * eur;
        const freightPerUnit = freightDKKTotal / qty;
        const duty = priceCcy==='JPY' ? netCost * dutyRate : 0;
        const totalUnitCost = netCost + freightPerUnit + duty;

        qs('#costDKK').textContent = fmtDKK(costDKK, rounding);
        qs('#netCost').textContent = fmtDKK(netCost, rounding);
        qs('#freightPerUnit').textContent = fmtDKK(freightPerUnit, rounding);
        qs('#dutyAmt').textContent = fmtDKK(duty, rounding);
        qs('#total').textContent = fmtDKK(totalUnitCost, rounding);
        qs('#notes').textContent = priceCcy==='JPY' ? '(Told anvendt)' : '(Ingen told)';
      }

      // FX fetching with simple fallback
      async function fetchFX(){
        qs('#fxInfo').textContent = 'Henter kurser…';
        let got = false;
        const setInfo = (msg, meta='') => { qs('#fxInfo').textContent = msg; qs('#fxInfo').dataset.meta = meta ? (msg + '|' + meta) : ''; save(); };

        try{
          const r = await fetch('https://api.exchangerate.host/latest?base=EUR&symbols=DKK,JPY');
          if(r.ok){
            const j = await r.json();
            const dkkPerEur = j.rates.DKK;
            const jpyPerEur = j.rates.JPY;
            if(dkkPerEur && jpyPerEur){
              const jpyToDkk = dkkPerEur / jpyPerEur;
              qs('#eur').value = dkkPerEur.toFixed(6).replace('.', ',');
              qs('#jpy').value = jpyToDkk.toFixed(6).replace('.', ',');
              const when = j.date || new Date().toISOString().slice(0,10);
              setInfo(`Kursdata: ${when} • Kilde: exchangerate.host`,'exchangerate.host');
              got = true;
            }
          }
        }catch(e){}

        if(!got){
          try{
            const r = await fetch('https://open.er-api.com/v6/latest/EUR');
            if(r.ok){
              const j = await r.json();
              const dkkPerEur = j.rates.DKK;
              const jpyPerEur = j.rates.JPY;
              if(dkkPerEur && jpyPerEur){
                const jpyToDkk = dkkPerEur / jpyPerEur;
                qs('#eur').value = dkkPerEur.toFixed(6).replace('.', ',');
                qs('#jpy').value = jpyToDkk.toFixed(6).replace('.', ',');
                const when = j.time_last_update_utc ? j.time_last_update_utc.split(' ').slice(0,4).join(' ') : new Date().toISOString().slice(0,10);
                setInfo(`Kursdata: ${when} • Kilde: er-api.com`,'er-api');
                got = true;
              }
            }
          }catch(e){}
        }

        if(!got){
          setInfo('Kunne ikke hente kurser – bruger standardværdier. Ret gerne selv.');
        }
        recalc();
      }

      // Reset
      qs('#reset').addEventListener('click', () => {
        localStorage.removeItem(LS_KEY);
        // defaults
        qs('#eur').value = '7,45';
        qs('#jpy').value = '0,046';
        qs('#dutyPct').value = '8,5';
        qsa('input[name=priceCcy]').forEach(x=> x.checked = (x.value==='JPY'));
        qsa('input[name=freightCcy]').forEach(x=> x.checked = (x.value==='JPY'));
        qs('#unitPrice').value = '';
        qs('#discount').value = '';
        qs('#freightTotal').value = '';
        qs('#qty').value = '';
        qs('#fxInfo').textContent = 'Kursdata: standardværdier (kan redigeres).';
        qs('#fxInfo').dataset.meta = '';
        hasInteracted = false;
        qs('#helper').style.display='block';
        recalc();
      });

      // Wire up
      load();
      fetchFX(); // try updating silently
      qsa('input').forEach(el=> el.addEventListener('input', ()=>{ save(); recalc(); }));
      qsa('input[type=radio][name=priceCcy],input[type=radio][name=freightCcy],#rounding').forEach(el=> el.addEventListener('change', ()=>{ save(); recalc(); }));
      qs('#refreshFx').addEventListener('click', fetchFX);
      recalc();
    })();
  </script>
</body>
</html>
