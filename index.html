<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cost Price Calculator — v3.3</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root { --bg:#f7f8fc; --fg:#0f172a; --muted:#475569; --card:#ffffff; --border:#e2e8f0; --accent:#0ea5e9; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;line-height:1.35}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    .h1{font-size:28px;font-weight:700;margin:0}
    .version{color:var(--muted);font-size:12px;margin-top:4px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .step{margin-top:16px}
    .step h2{font-size:18px;margin:0 0 10px}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px}
    input[type=text], select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px}
    input:focus, select:focus{border-color:#cbd5e1; box-shadow:0 0 0 3px rgba(148,163,184,.2); outline:none}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
    .btn:hover{background:#f8fafc}
    table{width:100%;border-collapse:collapse}
    th, td{border-bottom:1px solid var(--border);padding:8px;vertical-align:top}
    th{font-size:12px;color:var(--muted);text-align:left}
    .small{font-size:12px;color:var(--muted)}
    .statgrid{display:grid;gap:12px;margin-top:12px;margin-bottom:12px}
    @media(min-width:900px){.statgrid{grid-template-columns:repeat(4,1fr)}}
    .stat{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .stat .t{font-size:12px;color:var(--muted)}
    .stat .v{font-size:18px;font-weight:600;margin-top:4px}
    .ok{color:#065f46}
    .danger{color:#7f1d1d}
    .pill{display:inline-flex;align-items:center;gap:10px;padding:8px 10px;border-radius:12px;border:1px dashed #94a3b8; background:#f8fafc}
    .pill .label{font-size:12px;color:#334155}
    .pill .value{font-weight:700}
    .copy{cursor:pointer;border:1px solid #cbd5e1;padding:4px 8px;border-radius:8px;font-size:12px}
    .copy:active{opacity:.7}
    .hidden{display:none!important}
    footer{margin:28px 0;color:var(--muted);text-align:center;font-size:12px}

    /* Column widths — percentages per your spec */
    .col-index{width:5%}
    .col-desc{width:20%}
    .col-cost{width:10%}
    .col-rrp{width:15%}
    .col-shopify{width:15%}
    .col-overview{width:20%}
    .col-actions{width:4%}

    /* Indstillinger grid */
    .settings-grid{display:grid;gap:12px;margin-top:8px}
    @media(min-width:900px){.settings-grid{grid-template-columns:1fr 1fr 1fr}}
    .ibox{border:1px solid var(--border);border-radius:12px;padding:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="h1">Cost Price Calculator</h1>
    <div class="version">v3.3 — Kolonnefordeling & Oversigt til højre</div>

    <!-- Freight -->
    <section class="card step">
      <h2>Fragt</h2>
      <div class="row">
        <div style="min-width:200px">
          <label for="freightAmount">Fragt i alt</label>
          <input id="freightAmount" type="text" inputmode="decimal" placeholder="Indtast samlet fragt">
        </div>
        <div style="min-width:160px">
          <label for="freightCcy">Fragt valuta</label>
          <select id="freightCcy"></select>
        </div>
        <div style="min-width:220px">
          <label for="unitsOverride">Samlet antal enheder</label>
          <input id="unitsOverride" type="text" inputmode="numeric" placeholder="fx 250">
        </div>
        <div class="small" id="freightInfo">Fordeles ligeligt pr. stk og lægges i kostprisen (DKK).</div>
      </div>
    </section>

    <!-- Items -->
    <section class="card step">
      <div class="row" style="justify-content:space-between">
        <h2>Varelinjer</h2>
        <div class="row">
          <button class="btn" id="addRow">+ Tilføj linje</button>
          <label class="small"><input id="togglePerLineQty" type="checkbox"> Rediger antal pr. linje</label>
          <label class="small"><input id="togglePerLineCcy" type="checkbox"> Rediger valuta pr. linje</label>
        </div>
      </div>
      <div class="small">Tilføj de produkter du vil regne på.</div>
      <div style="overflow:auto;margin-top:8px">
        <table id="items">
          <thead>
            <tr>
              <th class="col-index">#</th>
              <th class="col-desc">Beskrivelse</th>
              <th class="col-cost" id="colCost">Kostpris</th>
              <th class="col-rrp" id="colRrpSug">Forslået RRP</th>
              <th class="col-rrp" id="colRrp">Din RRP</th>
              <th class="col-shopify">Shopify kostpris (DKK)</th>
              <th class="col-overview">Oversigt</th>
              <th class="col-actions"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small" id="itemsInfo" style="margin-top:10px">
        Fragt og evt. told er inkluderet i kostprisen (landed). “Shopify kostpris (DKK)” kan kopieres direkte til Shopify.
      </div>
    </section>

    <!-- Stats -->
    <section class="statgrid">
      <div class="stat"><div class="t">Antal i alt</div><div class="v" id="statQty">-</div></div>
      <div class="stat"><div class="t">Fragt pr. stk (DKK)</div><div class="v" id="statFreightPer">-</div></div>
      <div class="stat"><div class="t">Gns. kost (DKK, inkl. fragt)</div><div class="v" id="statAvgLanded">-</div></div>
      <div class="stat"><div class="t">Told i alt (DKK)</div><div class="v" id="statDuty">-</div></div>
    </section>

    <!-- Settings -->
    <section class="card step">
      <h2>Indstillinger</h2>
      <div class="settings-grid">
        <div class="ibox">
          <div style="font-weight:600;margin-bottom:6px">Valuta</div>
          <label for="costCcy">Standard kostpris-valuta</label>
          <select id="costCcy"></select>
          <div style="height:8px"></div>
          <label for="rrpCcy">RRP valuta</label>
          <select id="rrpCcy"></select>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="refreshFx">Opdatér valutakurser</button>
            <span id="fxInfo" class="small">Kursdata: standardværdier.</span>
          </div>
        </div>
        <div class="ibox">
          <div style="font-weight:600;margin-bottom:6px">Avance & skatter</div>
          <label for="markup">Avance‑multiplikator (fx 3 = x3)</label>
          <input id="markup" type="text" inputmode="decimal" value="3">
          <div style="height:8px"></div>
          <label for="dutyPct">Told (%) på varer udenfor EU</label>
          <input id="dutyPct" type="text" inputmode="decimal" value="8,5">
          <div style="height:8px"></div>
          <label><input id="pretty" type="checkbox" checked> Foreslå pæne priser (…99,00)</label>
          <div class="small">Moms antaget 25% (DK). I praksis lægges der told på linjer, hvor kostpris-valuta er JPY.</div>
        </div>
        <div class="ibox">
          <div style="font-weight:600;margin-bottom:6px">Valutakurser (1 valuta → DKK)</div>
          <div style="overflow:auto; max-height:260px">
            <table id="fxTable">
              <thead><tr><th style="width:120px">Valuta</th><th style="width:200px">1 → DKK</th><th>Note</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <footer>© 2025 | Sambeso ApS · All rights reserved</footer>
  </div>

  <script>
    const qs = (x) => document.querySelector(x);
    const qsa = (x) => Array.from(document.querySelectorAll(x));
    function toNumber(str){
      try{
        if (typeof str !== 'string') str = String(str ?? '');
        str = str.trim().replace(/\u00A0/g,''); // nbsp
        if (/^\d{1,3}(\.\d{3})+(,\d+)?$/.test(str)) str = str.replace(/\./g,'');
        str = str.replace(',', '.');
        const n = Number(str);
        return isFinite(n) ? n : NaN;
      }catch(e){ return NaN; }
    }
    function fmtAmount(n, d=2){
      return isNaN(n) ? '-' : n.toLocaleString('da-DK', {minimumFractionDigits:d, maximumFractionDigits:d});
    }
    const fmtCcy = (n, ccy) => isNaN(n) ? '-' : fmtAmount(n) + ' ' + ccy;
    function roundUpTo99(x){
      if (!isFinite(x) || x<=0) return x;
      return Math.ceil(x/100)*100 - 1;
    }
    const defaultRates = { DKK:1, EUR:7.45, JPY:0.046, USD:6.8, GBP:8.7, SEK:0.65, NOK:0.66, CNY:0.95 };
    let rates = {...defaultRates};
    function buildCurrencySelect(el){ el.innerHTML = Object.keys(rates).map(ccy => `<option value="${ccy}">${ccy}</option>`).join(''); }
    function renderFxTable(){
      const tbody = qs('#fxTable tbody'); tbody.innerHTML = '';
      Object.keys(rates).forEach(ccy => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><b>${ccy}</b></td>
                        <td><input data-ccy="${ccy}" class="rate" type="text" inputmode="decimal" value="${fmtAmount(rates[ccy],6)}"></td>
                        <td class="small">${ccy==='DKK'?'Danske kroner (basis)':'—'}</td>`;
        tbody.appendChild(tr);
      });
      tbody.oninput = (e)=>{
        if (e.target.classList.contains('rate')){
          const ccy = e.target.dataset.ccy;
          const v = toNumber(e.target.value);
          if (isFinite(v) && v>0) { rates[ccy] = v; recalcAll(); updateHeaders(); }
        }
      };
    }
    async function refreshFx(){
      const fxInfo = qs('#fxInfo'); if(fxInfo) fxInfo.textContent = 'Henter kurser…';
      let got = false;
      try{
        const symbols = Object.keys(rates).filter(k=>k!=='DKK').join(',');
        const r = await fetch(`https://api.exchangerate.host/latest?base=DKK&symbols=${symbols}`);
        if(r.ok){
          const j = await r.json();
          Object.keys(j.rates).forEach(ccy => { const perDKK = j.rates[ccy]; if (perDKK && perDKK>0) rates[ccy] = 1/perDKK; });
          if(fxInfo) fxInfo.textContent = `Kursdata: ${j.date} • Kilde: exchangerate.host`;
          got = true;
        }
      }catch(e){}
      if(!got){
        try{
          const r = await fetch('https://open.er-api.com/v6/latest/EUR');
          if(r.ok){
            const j = await r.json();
            const eur_per_dkk = 1 / j.rates.DKK;
            Object.keys(rates).forEach(ccy => { if(ccy==='DKK') return; const c_per_eur = j.rates[ccy]; if(c_per_eur>0){ rates[ccy] = (1/eur_per_dkk) / c_per_eur; } });
            if(fxInfo) fxInfo.textContent = `Kursdata: ${j.time_last_update_utc.split(' ').slice(0,4).join(' ')} • Kilde: er-api.com`;
            got = true;
          }
        }catch(e){}
      }
      if(!got){
        try{
          const r = await fetch('https://www.ecb.europa.eu/stats/eurofxref/eurofxref-daily.xml');
          if(r.ok){
            const tx = await r.text();
            const ratesEur = {};
            tx.replace(/currency=['"]([A-Z]{3})['"]\s+rate=['"]([0-9.]+)['"]/g, (_, ccy, rate) => { ratesEur[ccy] = parseFloat(rate); });
            const dkkPerEur = ratesEur['DKK'];
            Object.keys(rates).forEach(ccy => { if(ccy==='DKK') return; const ccyPerEur = ratesEur[ccy]; if (dkkPerEur && ccyPerEur){ rates[ccy] = dkkPerEur / ccyPerEur; } });
            const when = (tx.match(/time=['"]([0-9-]+)['"]/)||[])[1] || '';
            if(fxInfo) fxInfo.textContent = `Kursdata: ${when} • Kilde: ECB`;
            got = true;
          }
        }catch(e){}
      }
      if(!got && fxInfo){ fxInfo.textContent = 'Kunne ikke hente kurser – bruger værdierne i tabellen.'; }
      renderFxTable(); recalcAll(); updateHeaders();
    }
    function addRow(prefill={}){
      const tbody = qs('#items tbody');
      const idx = tbody.children.length + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="col-index">${idx}</td>
        <td class="col-desc"><input class="desc" type="text" placeholder="Beskrivelse" value="${(prefill.description||'').replace(/"/g,'&quot;')}"></td>
        <td class="col-cost"><input class="price" type="text" inputmode="decimal" placeholder="0,00" value="${prefill.unitPrice||''}"></td>
        <td class="col-rrp rrp-sug num"><span class="pill"><span class="label">Forslag</span><span class="value">-</span><button class="copy">Kopiér</button></span></td>
        <td class="col-rrp"><div class="row" style="gap:8px"><input class="rrp" type="text" inputmode="decimal" placeholder=""><button class="copy copy-rrp">Kopiér</button></div></td>
        <td class="col-shopify shopify-cost"><span class="pill"><span class="label">Shopify kostpris</span><span class="value">-</span><button class="copy">Kopiér</button></span></td>
        <td class="col-overview margin num small">-<div class="small freightShare">Fragt pr. stk: -</div></td>
        <td class="col-actions"><button class="btn del">×</button></td>`;
      tbody.appendChild(tr);
      // copy handlers
      const cleanForCopy = (s)=> (s||'').replace(/[^\d,.-]/g,'').replace(/\.$/,'').trim();
      tr.querySelector('.shopify-cost .copy').addEventListener('click', ()=>{
        const val = tr.querySelector('.shopify-cost .value')?.textContent || '';
        const clean = cleanForCopy(val);
        if (clean) { navigator.clipboard.writeText(clean); }
      });
      tr.querySelector('.rrp-sug .copy').addEventListener('click', ()=>{
        const val = tr.querySelector('.rrp-sug .value')?.textContent || '';
        const clean = cleanForCopy(val);
        if (clean) { navigator.clipboard.writeText(clean); }
      });
      tr.querySelector('.copy-rrp').addEventListener('click', ()=>{
        const val = tr.querySelector('.rrp')?.value || '';
        const clean = cleanForCopy(val);
        if (clean) { navigator.clipboard.writeText(clean); }
      });
      applyQtyVisibility(tr);
      recalcRow(tr);
    }
    function collectRows(){
      return qsa('#items tbody tr').map(tr => ({
        tr,
        unitPrice: toNumber(tr.querySelector('.price')?.value),
        ccy: (qs('#togglePerLineCcy').checked ? tr.querySelector('.ccy')?.value : qs('#costCcy').value),
        rrpInput: toNumber(tr.querySelector('.rrp')?.value),
        description: (tr.querySelector('.desc')?.value || '').trim()
      }));
    }
    function freightPerUnitDKK(){
      const freightCcy = qs('#freightCcy').value;
      const freightAmt = toNumber(qs('#freightAmount').value) || 0;
      const divisor = toNumber(qs('#unitsOverride').value) || 0;
      const freightDKK = (rates[freightCcy]||0) * freightAmt;
      const per = divisor>0 ? freightDKK / divisor : 0;
      const info = qs('#freightInfo');
      if (info){
        info.textContent = `Fordeles ligeligt på ${divisor||0} enheder → ${fmtCcy(per, 'DKK')} pr. stk og lægges i kostprisen (DKK).`;
      }
      return per;
    }
    function recalcRow(tr){
      const dutyPct = toNumber(qs('#dutyPct').value) || 0;
      const dutyRate = dutyPct/100;
      const markup = toNumber(qs('#markup').value) || 3;
      const pretty = qs('#pretty').checked;
      const rrpCcy = qs('#rrpCcy').value;
      const freightPerUnit = freightPerUnitDKK();
      const unitPrice = toNumber(tr.querySelector('.price')?.value) || 0;
      const ccy = qs('#costCcy').value;
      const rrpInput = toNumber(tr.querySelector('.rrp')?.value);
      const rate = rates[ccy] || 0;
      const unitCostDKK = unitPrice * rate;
      const duty = (ccy==='JPY') ? unitCostDKK * dutyRate : 0;
      const landed = unitCostDKK + duty + freightPerUnit;
      const shop = tr.querySelector('.shopify-cost .value');
      if (shop) shop.textContent = fmtCcy(landed, 'DKK');
      const fs = tr.querySelector('.freightShare'); if (fs) fs.textContent = `Fragt pr. stk: ${fmtCcy(freightPerUnit, 'DKK')}`;
      const rrpRate = rates[rrpCcy] || 1;
      const rrpExVatDKK = landed * markup;
      const rrpInclVatDKK = rrpExVatDKK * 1.25;
      let rrpInclVatInCcyRaw = rrpInclVatDKK / rrpRate;
      if (pretty) rrpInclVatInCcyRaw = roundUpTo99(rrpInclVatInCcyRaw);
      const sugVal = tr.querySelector('.rrp-sug .value'); if (sugVal) sugVal.textContent = fmtCcy(rrpInclVatInCcyRaw, rrpCcy);
      const rrpInclVatInCcy = (isFinite(rrpInput)&&rrpInput>0) ? rrpInput : rrpInclVatInCcyRaw;
      const rrpInclVatDKK2 = rrpInclVatInCcy * rrpRate;
      const exVatCcy = rrpInclVatInCcy / 1.25;
      const vatCcy = rrpInclVatInCcy - exVatCcy;
      const exVatDKK = rrpInclVatDKK2 / 1.25;
      const grossMarginDKK = exVatDKK - landed;
      const marginPct = exVatDKK>0 ? (grossMarginDKK / exVatDKK) : NaN;
      const marginEl = tr.querySelector('.margin');
      if (marginEl){
        marginEl.innerHTML = `
          Kost (DKK): <b>${fmtCcy(landed, 'DKK')}</b><br>
          Told (DKK): ${fmtCcy(duty, 'DKK')}<br>
          Ex. moms: ${fmtCcy(exVatCcy, rrpCcy)}<br>
          Moms: ${fmtCcy(vatCcy, rrpCcy)}<br><br>
          Dækningsbidrag: <span class="${grossMarginDKK>=0?'ok':'danger'}"><b>${fmtCcy(grossMarginDKK, 'DKK')}</b> (${isNaN(marginPct)?'-':(marginPct*100).toFixed(1)}%)</span>
        `;
      }
      updateTotals();
    }
    function recalcAll(){ qsa('#items tbody tr').forEach(tr => recalcRow(tr)); updateHeaders(); }
    function updateHeaders(){
      const costCcy = qs('#costCcy').value;
      const rrpCcy = qs('#rrpCcy').value;
      const a = qs('#colCost'); if (a) a.textContent = `Kostpris (${costCcy})`;
      const b = qs('#colRrpSug'); if (b) b.textContent = `Forslået RRP (${rrpCcy})`;
      const c = qs('#colRrp'); if (c) c.textContent = `Din RRP (${rrpCcy})`;
    }
    function totalsContext(){
      const rows = collectRows();
      const per = freightPerUnitDKK();
      let sumLanded = 0, sumExVatDKK = 0, sumDuty = 0, sumQty = rows.length;
      const markup = toNumber(qs('#markup').value)||3, dutyRate = (toNumber(qs('#dutyPct').value)||0)/100, ccy = qs('#costCcy').value;
      rows.forEach(r => {
        const unitCostDKK = (r.unitPrice||0) * (rates[ccy]||0);
        const duty = (ccy==='JPY') ? unitCostDKK * dutyRate : 0;
        const landed = unitCostDKK + duty + per;
        sumDuty += duty;
        sumLanded += landed;
        sumExVatDKK += landed * markup;
      });
      return { per, sumLanded, sumDuty, sumQty };
    }
    function updateTotals(){
      const t = totalsContext();
      const elQty = qs('#statQty'); if (elQty) elQty.textContent = t.sumQty || '-';
      const elFreight = qs('#statFreightPer'); if (elFreight) elFreight.textContent = fmtCcy(t.per, 'DKK');
      const elAvg = qs('#statAvgLanded'); if (elAvg) elAvg.textContent = (t.sumQty>0 ? fmtCcy(t.sumLanded/t.sumQty, 'DKK') : '-');
      const elDuty = qs('#statDuty'); if (elDuty) elDuty.textContent = fmtCcy(t.sumDuty, 'DKK');
    }
    (function init(){
      ['#costCcy','#rrpCcy','#freightCcy'].forEach(sel => buildCurrencySelect(qs(sel)));
      qs('#costCcy').value='JPY'; qs('#rrpCcy').value='DKK'; qs('#freightCcy').value='JPY';
      renderFxTable();
      addRow();
      refreshFx();
      qs('#addRow').addEventListener('click', ()=> addRow());
      ['#markup','#dutyPct','#pretty','#costCcy','#rrpCcy','#freightAmount','#freightCcy','#unitsOverride'].forEach(id=>{
        const el = qs(id); ['input','change','keyup'].forEach(evt => el.addEventListener(evt, ()=>{ updateHeaders(); recalcAll(); }));
      });
      qs('#items').addEventListener('input', (e)=>{
        const tr = e.target.closest('tr'); if(!tr) return;
        if (e.target.matches('input')) recalcRow(tr);
      });
      qs('#items').addEventListener('click', (e)=>{
        if (e.target.classList.contains('del')){
          const tr = e.target.closest('tr'); tr.remove();
          qsa('#items tbody tr').forEach((row, i)=> row.firstElementChild.textContent = i+1);
          recalcAll();
        }
      });
      updateHeaders(); recalcAll();
    })();
  </script>
</body>
</html>
